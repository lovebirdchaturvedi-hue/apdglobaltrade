<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Admin Dashboard â€“ APD Global Trade</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
    th { background: #f5f5f5; }
    button { margin-right: 5px; }
  </style>
</head>

<body>

<h2>Admin Dashboard â€“ Suppliers</h2>

<button id="logoutBtn">Logout</button>

<table>
  <thead>
    <tr>
      <th>Company</th>
      <th>Email</th>
      <th>Status</th>
      <th>Action</th>
    </tr>
  </thead>
  <tbody id="supplierTable"></tbody>
</table>

<p id="msg" style="color:red;"></p>

<script type="module">
import { auth, db } from "./js/firebase-init.js";
import { onAuthStateChanged, signOut } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { collection, getDocs, updateDoc, doc } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ðŸ” ADMIN GUARD */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "/supplier-login.html";
    return;
  }

  const token = await user.getIdTokenResult();
  if (token.claims.role !== "admin") {
    alert("Access denied");
    window.location.href = "/supplier-login.html";
    return;
  }

  loadSuppliers();
});

/* ðŸ“‹ LOAD SUPPLIERS */
async function loadSuppliers() {
  const table = document.getElementById("supplierTable");
  table.innerHTML = "";

  const snap = await getDocs(collection(db, "suppliers"));

  snap.forEach(docSnap => {
    const s = docSnap.data();
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${s.companyName || "-"}</td>
      <td>${s.email}</td>
      <td>${s.status}</td>
      <td>
        ${s.status === "pending" ? `
          <button onclick="approve('${docSnap.id}')">Approve</button>
          <button onclick="reject('${docSnap.id}')">Reject</button>
        ` : "-"}
      </td>
    `;

    table.appendChild(tr);
  });
}

/* âœ… APPROVE SUPPLIER (Cloud Function) */
window.approve = async (uid) => {
  const token = await auth.currentUser.getIdToken();

  const res = await fetch(
    "https://us-central1-apd-globaltrade-prod.cloudfunctions.net/approveSupplier",
    {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ uid })
    }
  );

  if (res.ok) {
    alert("Supplier approved");
    loadSuppliers();
  } else {
    alert("Approval failed");
  }
};

/* âŒ REJECT SUPPLIER */
window.reject = async (uid) => {
  await updateDoc(doc(db, "suppliers", uid), {
    status: "rejected"
  });

  alert("Supplier rejected");
  loadSuppliers();
};

/* ðŸ”“ LOGOUT */
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await signOut(auth);
  window.location.href = "/supplier-login.html";
});
</script>

</body>
</html>
