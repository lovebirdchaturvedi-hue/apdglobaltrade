<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Supplier Login â€“ APD Global Trade</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 40px;
      display: block;
    }
    input, button {
      display: block;
      margin: 10px 0;
      padding: 8px;
      width: 260px;
    }
    button {
      cursor: pointer;
    }
    #error {
      color: red;
      margin-top: 10px;
    }
  </style>
</head>

<body>

  <h2>Login</h2>

  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Password" />

  <button id="loginBtn">Login</button>

  <div id="error"></div>

  <!-- âœ… LOGIN + REDIRECT LOGIC -->
  <script type="module">
    import { auth, db } from "./js/firebase-init.js";
    import {
      signInWithEmailAndPassword,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import {
      doc,
      getDoc
    } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const emailEl = document.getElementById("email");
    const passwordEl = document.getElementById("password");
    const errorEl = document.getElementById("error");
    const loginBtn = document.getElementById("loginBtn");

    // ðŸ” LOGIN CLICK
    loginBtn.addEventListener("click", async () => {
      errorEl.innerText = "";
      try {
        await signInWithEmailAndPassword(
          auth,
          emailEl.value,
          passwordEl.value
        );
      } catch (err) {
        errorEl.innerText = err.message;
      }
    });

    // ðŸ” AUTH STATE HANDLER
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;

      // ðŸ”¥ CHECK ADMIN FIRST
      const token = await user.getIdTokenResult(true);
      if (token.claims.role === "admin") {
        window.location.href = "/admin-dashboard.html";
        return;
      }

      // ðŸ”¹ SUPPLIER FLOW
      const ref = doc(db, "suppliers", user.uid);
      const snap = await getDoc(ref);

      if (!snap.exists()) {
        window.location.href = "/register-supplier.html";
        return;
      }

      const data = snap.data();

      if (data.status === "approved") {
        window.location.href = "/supplier-dashboard.html";
      } else if (data.status === "rejected") {
        window.location.href = "/account-rejected.html";
      } else {
        window.location.href = "/pending-approval.html";
      }
    });
  </script>

</body>
</html>
