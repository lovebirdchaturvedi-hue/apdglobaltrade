<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Register as Supplier â€“ APD Global Trade</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</head>

<body>

<h2>Supplier Registration</h2>

<form id="supplierForm">
  <input type="text" id="companyName" placeholder="Company Name" required /><br><br>
  <input type="text" id="contactPerson" placeholder="Contact Person" required /><br><br>
  <input type="text" id="phone" placeholder="Phone Number" required /><br><br>
  <input type="text" id="country" placeholder="Country" required /><br><br>
  <textarea id="products" placeholder="Products you deal in" required></textarea><br><br>

  <button type="submit">Submit for Approval</button>
</form>

<p id="msg" style="margin-top:15px;color:red;"></p>

<script type="module">
import { auth, db } from "./js/firebase-init.js";
import { onAuthStateChanged } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { doc, setDoc, getDoc, serverTimestamp } from
  "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const form = document.getElementById("supplierForm");
const msg = document.getElementById("msg");

let currentUser = null;

/* ðŸ” Ensure user is logged in */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "/supplier-login.html";
    return;
  }

  currentUser = user;

  // Prevent duplicate registration
  const ref = doc(db, "suppliers", user.uid);
  const snap = await getDoc(ref);

  if (snap.exists()) {
    const status = snap.data().status;

    if (status === "approved") {
      window.location.href = "/supplier-dashboard.html";
    } else if (status === "pending") {
      window.location.href = "/pending-approval.html";
    } else if (status === "rejected") {
      window.location.href = "/account-rejected.html";
    }
  }
});

/* ðŸ“ Submit supplier registration */
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  msg.innerText = "";

  if (!currentUser) return;

  try {
    await setDoc(doc(db, "suppliers", currentUser.uid), {
      uid: currentUser.uid,
      email: currentUser.email,
      companyName: document.getElementById("companyName").value,
      contactPerson: document.getElementById("contactPerson").value,
      phone: document.getElementById("phone").value,
      country: document.getElementById("country").value,
      products: document.getElementById("products").value,
      status: "pending",
      createdAt: serverTimestamp()
    });

    msg.style.color = "green";
    msg.innerText = "Submitted successfully. Waiting for admin approval â³";

    setTimeout(() => {
      window.location.href = "/pending-approval.html";
    }, 1500);

  } catch (err) {
    msg.style.color = "red";
    msg.innerText = err.message;
  }
});
</script>

</body>
</html>
